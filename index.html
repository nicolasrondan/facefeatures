<html>
<head>

<style>
img {
  float: left;
  width: 200px;
  height: 60px;
  background: #555;
}


canvas {
 
  width: 640px;
  height: 480px;
  display : block;   
  margin : auto;
  text-align: center;
}

h1 {
  width: 320px;
  height:50px;
  
  
  margin: 0px auto;
  text-align: center;
}


</style>

<div class="header">
  <img src="img/logo.png" alt="logo" />
  <h1>Face features test</h1>
</div>

</head>
<body>


<div id="container">
 <canvas class="center-block" id="canvasOutput" width="640" height="480"></canvas>
</div>
<div class="video_container" style="visibility: hidden" >
  <video id="video" class="hidden">Your browser does not support the video tag.</video>
  <input id="playbutton" type="button" value="Play" width="200" height="50" style="visibility:hidden;" onclick="initCamera()">
</div>

<script type="text/javascript">
  
	// frame variables
	let imgWidth = 640;
	let imgHeight = 480;
	let imgBpp = 4; // can i read directly from video element ??
	
	// html video variables
	let canvasInput = null;
	let canvasInputCtx = null;
	let canvasOutput = document.getElementById('canvasOutput');
	let canvasOutputCtx = canvasOutput.getContext('2d');
	let imageDataOut = canvasOutputCtx.createImageData(imgWidth, imgHeight);
	let streaming = false;
	let video = document.getElementById('video');
	let resolution = {width: {exact: 640}, height: {exact: 480}};
	
	
	
	// face detector variables
	let heap_img_buffer = null;
	let frameProcessor = null;
	
	function processVideo() {
	
		// draw captured image
		canvasInputCtx.drawImage(video, 0, 0, imgWidth, imgHeight);
		
		// get captured image
		let imageData = canvasInputCtx.getImageData(0, 0, imgWidth, imgHeight);
		
		// copy iamge to heap memory
		let heapArray = Module.HEAPU8.subarray(heap_img_buffer, heap_img_buffer + (imgWidth * imgHeight * imgBpp));
		heapArray.set(imageData.data);
		
		// process frame
		frameProcessor.process(heap_img_buffer, imgWidth, imgHeight, imgBpp);
		
		// get result data		
		imageDataOut.data.set(heapArray);

		// draw result
		canvasOutputCtx.putImageData(imageDataOut, 0, 0);
		
		// request next frame
		requestAnimationFrame(processVideo);
	}
	
	function stopVideoProcessing() {
	
		if (frameProcessor) {
		
			frameProcessor.delete();
			frameProcessor = null;
		}
	}
	
	function startVideoProcessing() {
  
		if (!streaming) { console.warn("Please startup your webcam"); return; }
	  
		stopVideoProcessing();
		
		// canvas to put input video frame
		canvasInput = document.createElement('canvas');
		canvasInput.width = imgWidth;
		canvasInput.height = imgHeight;
		canvasInputCtx = canvasInput.getContext('2d');
		
		// read json
		let json = FS.readFile('/data/config.json', { encoding: 'utf8' });
		
		// create detector
		frameProcessor = new Module.FrameProcessor(json);		

		// reserve buffer on heap
		heap_img_buffer = Module._malloc(imgWidth * imgHeight * imgBpp);

		// request next frame
		requestAnimationFrame(processVideo);
	}

	function stopCamera() {

		if (!streaming) return;
	  
		stopVideoProcessing();
		document.getElementById("canvasOutput").getContext("2d").clearRect(0, 0, width, height);
		video.pause();
		video.srcObject=null;
		stream.getVideoTracks()[0].stop();
		streaming = false;
	}

	function startCamera(callback) {
	  
		if (streaming) return;
	
		navigator.mediaDevices.getUserMedia({video: resolution, audio: false})
		.then(function(s) {
		
			stream = s;
			video.srcObject = s;
			video.play();
		})
		.catch(function(err) {
		
			console.log("An error occured! " + err);
		});

		video.addEventListener("canplay", function(ev){
		
			if (!streaming) {
			
			  imgWidth = video.videoWidth;
			  imgHeight = video.videoHeight;
			  video.setAttribute("width", imgWidth);
			  video.setAttribute("height", imgHeight);
			  canvasOutput.width = imgWidth;
			  canvasOutput.height = imgHeight;			  
			  streaming = true;
			}
			if (callback) {
			
				callback();
			}
		}, false);
	}

	function initCamera() {
	
		startCamera(function() {
		
			startVideoProcessing();
		});
	}
	
	function isIOS() {
		
		return !!navigator.platform && /iPad|iPhone|iPod/.test(navigator.platform);
	}
	function main() {

		if (isIOS() == false ) {
		
			initCamera();
		} else {
		
			document.getElementById("playbutton").style.visibility = "visible";
			console.log("IOS DETECTED");
		}
	}
  
  var Module = {
     'preRun' : function(){
	
		Module.FS_createFolder('/', 'data', true, true);
		Module.FS_createPreloadedFile('/data', 'config.json', './data/config.json', true, false);  
		Module.FS_createPreloadedFile('/data', 'haarcascade_frontalface_alt2.xml', './data/haarcascade_frontalface_alt2.xml', true, false);  
		Module.FS_createPreloadedFile('/data', 'shape_predictor_68_face_landmarks.dat', './data/shape_predictor_68_face_landmarks.dat', true, false);
	},
	'onRuntimeInitialized' : function(){
	
		main();
	}
  };
</script>
<script async src="test_ems_frame_proc.js"></script>
</body>
</html>