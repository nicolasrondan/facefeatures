<html>
<head>

<style>
img {
  float: left;
  width: 200px;
  height: 60px;
  background: #555;
}


canvas {
 
  width: 640px;
  height: 480px;
  display : block;   
  margin : auto;
  text-align: center;
}

h1 {
  width: 320px;
  height:50px;
  
  
  margin: 0px auto;
  text-align: center;
}


</style>

<div class="header">
  <img src="img/logo.png" alt="logo" />
  <h1>Face features test</h1>
</div>

</head>
<body>

<!--
<div id="container">
 
 <canvas class="center-block" id="canvasOutput" width="640" height="480"></canvas>
 
</div>

<div class="video_container" style="visibility: hidden" >

  <video id="video_original" class="hidden">Your browser does not support the video tag.</video>
  
</div>
-->

<div id="container">

	<video id="video_src" playsinline autoplay></video>
    <!--<canvas id="canvas_src" ></canvas>-->
	<canvas id="canvas_dest" ></canvas>
</div>
	
<script type="text/javascript">  
	
	// html video variables
	/*
	let canvasInput = null;
	let canvasInputCtx = null;
	let canvasOutput = document.getElementById('canvasOutput');
	let canvasOutputCtx = canvasOutput.getContext('2d');
	let imageDataOut = canvasOutputCtx.createImageData(imgWidth, imgHeight);
	
	let video = document.getElementById('video');
	let resolution = {width: {exact: 640}, height: {exact: 480}};
	*/
	
	let streaming = false;
	
	// face detector variables
	let heap_img_buffer = null;
	let frameProcessor = null;
	
	// video config
	const video = document.getElementById('video_src');
	let imgBpp = 4; // can i read directly from video element ??
	
	const canvas_src = window.canvas_src = document.createElement('canvas');
	const canvas_dest = window.canvas_src = document.getElementById('canvas_dest');
	
	let imageDataOut = null;
	let canvas_src_ctx = canvas_src.getContext('2d');
	let canvas_dest_ctx = canvas_dest.getContext('2d');
	
	const constraints = {
	
		audio: false,
		video: true
	};

	function handleSuccess(stream) {
	
		window.stream = stream; // make stream available to browser console
		video.srcObject = stream;
	}

	function handleError(error) {
  
		console.log('navigator.MediaDevices.getUserMedia error: ', error.message, error.name);
	}

	
	
	function initSystem() {
	
		var imgWidth = video.videoWidth;
		var imgHeight = video.videoHeight;

		// setup canvas
		canvas_src.width = imgWidth;
		canvas_src.height = imgHeight;
		canvas_dest.width = imgWidth;
		canvas_dest.height = imgHeight;		
		canvas_src_ctx = canvas_src.getContext('2d');
		canvas_dest_ctx = canvas_dest.getContext('2d');
		
		// create out buffer
		imageDataOut = canvas_dest_ctx.createImageData(imgWidth, imgHeight);
		
		// read json
		let json = FS.readFile('/data/config.json', { encoding: 'utf8' });
		
		// create detector
		frameProcessor = new Module.FrameProcessor(json);
		
		// reserve buffer on heap
		heap_img_buffer = Module._malloc(canvas_src.width * canvas_src.height * imgBpp);
	}
	
	function initCapture() {
		
		video.addEventListener("canplay", function(ev) {
		
			if (!streaming) {
			
			  initSystem();
			  streaming = true;
			}
			drawFrame();
		});
		
		navigator.mediaDevices.getUserMedia(constraints).then(handleSuccess).catch(handleError);
	}
	
	function drawFrame() {
	
		// draw captured image
		canvas_src_ctx.drawImage(video, 0, 0, canvas_src.width, canvas_src.height);
		
		// get captured image
		let imageData = canvas_src_ctx.getImageData(0, 0, canvas_src.width, canvas_src.height);
		
		// copy iamge to heap memory
		let heapArray = Module.HEAPU8.subarray(heap_img_buffer, heap_img_buffer + (canvas_src.width * canvas_src.height * imgBpp));
		heapArray.set(imageData.data);
			
		// process frame
		frameProcessor.process(heap_img_buffer, imgWidth, imgHeight, imgBpp);
		
		// get result data		
		imageDataOut.data.set(heapArray);
		
		// draw result
		canvas_dest_ctx.putImageData(imageDataOut, 0, 0, 0, 0, canvas_src.width, canvas_src.height);
	
		// request next frame
		requestAnimationFrame(drawFrame);
	}
	
	function processVideo() {
	
		// draw captured image
		canvasInputCtx.drawImage(video, 0, 0, imgWidth, imgHeight);
		
		// get captured image
		let imageData = canvasInputCtx.getImageData(0, 0, imgWidth, imgHeight);
		
		// copy iamge to heap memory
		let heapArray = Module.HEAPU8.subarray(heap_img_buffer, heap_img_buffer + (imgWidth * imgHeight * imgBpp));
		heapArray.set(imageData.data);
		
		// process frame
		frameProcessor.process(heap_img_buffer, imgWidth, imgHeight, imgBpp);
		
		// get result data		
		imageDataOut.data.set(heapArray);

		// draw result
		canvasOutputCtx.putImageData(imageDataOut, 0, 0);
		
		// request next frame
		requestAnimationFrame(processVideo);
	}
	
	function stopVideoProcessing() {
	
		if (frameProcessor) {
		
			frameProcessor.delete();
			frameProcessor = null;
		}
	}
	
	function startVideoProcessing() {
  
		if (!streaming) { console.warn("Please startup your webcam"); return; }
	  
		stopVideoProcessing();
		
		// canvas to put input video frame
		canvasInput = document.createElement('canvas');
		canvasInput.width = imgWidth;
		canvasInput.height = imgHeight;
		canvasInputCtx = canvasInput.getContext('2d');
		
		// read json
		let json = FS.readFile('/data/config.json', { encoding: 'utf8' });
		
		// create detector
		frameProcessor = new Module.FrameProcessor(json);		

		// reserve buffer on heap
		heap_img_buffer = Module._malloc(imgWidth * imgHeight * imgBpp);

		// request next frame
		requestAnimationFrame(processVideo);
	}

	function stopCamera() {

		if (!streaming) return;
	  
		stopVideoProcessing();
		document.getElementById("canvasOutput").getContext("2d").clearRect(0, 0, width, height);
		video.pause();
		video.srcObject=null;
		stream.getVideoTracks()[0].stop();
		streaming = false;
	}

	function startCamera(callback) {
	  
		if (streaming) return;
	
		navigator.mediaDevices.getUserMedia({video: resolution, audio: false})
		.then(function(s) {
		
			stream = s;
			video.srcObject = s;
			video.play();
		})
		.catch(function(err) {
		
			console.log("An error occured! " + err);
		});

		video.addEventListener("canplay", function(ev){
		
			if (!streaming) {
			
			  imgWidth = video.videoWidth;
			  imgHeight = video.videoHeight;
			  video.setAttribute("width", imgWidth);
			  video.setAttribute("height", imgHeight);
			  canvasOutput.width = imgWidth;
			  canvasOutput.height = imgHeight;			  
			  streaming = true;
			}
			if (callback) {
			
				callback();
			}
		}, false);
	}

	function main() {
		
		startCamera(function() {
		
			startVideoProcessing();
		});
	}
  
  var Module = {
     'preRun' : function(){
	
		Module.FS_createFolder('/', 'data', true, true);
		Module.FS_createPreloadedFile('/data', 'config.json', './data/config.json', true, false);  
		Module.FS_createPreloadedFile('/data', 'haarcascade_frontalface_alt2.xml', './data/haarcascade_frontalface_alt2.xml', true, false);  
		Module.FS_createPreloadedFile('/data', 'shape_predictor_68_face_landmarks.dat', './data/shape_predictor_68_face_landmarks.dat', true, false);
	},
	'onRuntimeInitialized' : function(){
	
		//main();
		initCapture();
	}
  };
</script>
<script async src="test_ems_frame_proc.js"></script>
</body>
</html>